<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãƒ»ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ¼ãƒˆ (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ä»˜ã)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js (Markdownãƒ‘ãƒ¼ã‚µãƒ¼) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- DOMPurify (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ‹ã‚¿ã‚¤ã‚¶ãƒ¼) -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@latest/dist/purify.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }

        .quick-add-btn {
            @apply px-3 py-1 bg-gray-200 dark:bg-gray-700 text-sm rounded-full hover:bg-indigo-500 hover:text-white transition-colors cursor-pointer;
        }

        #mic-btn.recording {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .preview-content h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.3em;
            margin-top: 1.5em;
            margin-bottom: 1em;
        }

        .preview-content p {
            margin-bottom: 1em;
            line-height: 1.7;
        }

        .preview-content ul {
            list-style-type: disc;
            margin-left: 1.5em;
            margin-bottom: 1em;
        }

        .preview-content a {
            color: #3b82f6;
            text-decoration: underline;
        }

        .preview-content strong {
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-4 md:p-6">

    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold">ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãƒ»ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ¼ãƒˆ</h1>
            <p class="mt-1 text-gray-600 dark:text-gray-400">æ—¥ã€…ã®è¨˜éŒ²ã‚’ã€æ§‹é€ åŒ–ã•ã‚ŒãŸæƒ…å ±ã¸ã€‚</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- å·¦å´: å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold">1. ä»Šæ—¥ã®å‡ºæ¥äº‹ã‚’å…¥åŠ›</h2>
                    <div class="flex items-center gap-2">
                        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
                        <div class="relative">
                            <button id="template-btn"
                                class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
                                title="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                            </button>
                            <div id="template-dropdown"
                                class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-700 rounded-md shadow-lg z-20">
                                <a href="#"
                                    class="template-item block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600"
                                    data-template-id="readingMemo">ğŸ“– èª­æ›¸ãƒ¡ãƒ¢</a>
                                <a href="#"
                                    class="template-item block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600"
                                    data-template-id="meetingMinutes">ğŸ‘¥ ä¼šè­°ã®è­°äº‹éŒ²</a>
                                <a href="#"
                                    class="template-item block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600"
                                    data-template-id="ideaMemo">ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚¢ãƒ¡ãƒ¢</a>
                            </div>
                        </div>
                        <button id="mic-btn"
                            class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
                            title="éŸ³å£°å…¥åŠ›">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="quick-add-container" class="flex flex-wrap gap-2 mb-3">
                    <button class="quick-add-btn" data-template="- **[ä»•äº‹]** ">ğŸ’¼ ä»•äº‹</button>
                    <button class="quick-add-btn" data-template="- **[é£Ÿäº‹]** ">ğŸœ é£Ÿäº‹</button>
                    <button class="quick-add-btn" data-template="- **[å¥åº·]** ">ğŸ’ª å¥åº·</button>
                    <button class="quick-add-btn" data-template="- **[è³¼å…¥]** ">ğŸ›’ è³¼å…¥</button>
                    <button class="quick-add-btn" data-template="- **[ãƒ¡ãƒ¢]** ">ğŸ“ ãƒ¡ãƒ¢</button>
                    <button class="quick-add-btn" data-template="- **[ãƒªãƒ³ã‚¯]** [ã‚¿ã‚¤ãƒˆãƒ«](URL)">ğŸ”— ãƒªãƒ³ã‚¯</button>
                    <button class="quick-add-btn" data-template="- [ ] ">âœ… ã‚¿ã‚¹ã‚¯</button>
                    <button id="add-custom-btn" class="quick-add-btn bg-indigo-200 dark:bg-indigo-800">ï¼‹ ã‚«ã‚¹ã‚¿ãƒ </button>
                </div>

                <textarea id="entry-input" rows="15"
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 flex-grow"
                    placeholder="ã“ã“ã«ä»Šæ—¥ã®å‡ºæ¥äº‹ã‚’æ›¸ãç•™ã‚ã¦ã„ãã¾ã™..."></textarea>
                <p id="save-status" class="text-xs text-gray-400 mt-2 h-4"></p>
            </div>

            <!-- å³å´: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold">2. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
                    <button id="copy-btn"
                        class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition">ã‚³ãƒ”ãƒ¼</button>
                </div>
                <div id="preview-content"
                    class="w-full flex-grow p-4 border border-gray-200 dark:border-gray-700 rounded-lg overflow-y-auto">
                    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒœã‚¿ãƒ³è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg w-full max-w-md">
            <h3 class="text-lg font-bold mb-4">ã‚«ã‚¹ã‚¿ãƒ ãƒœã‚¿ãƒ³ã‚’è¿½åŠ </h3>
            <div class="space-y-4">
                <input id="custom-label" type="text" placeholder="ãƒ©ãƒ™ãƒ« (ä¾‹: èª­æ›¸)"
                    class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                <input id="custom-template" type="text" placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (ä¾‹: - **[èª­æ›¸]** )"
                    class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button id="cancel-custom-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="save-custom-btn" class="px-4 py-2 bg-blue-600 text-white rounded">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        const entryInput = document.getElementById('entry-input');
        const previewContent = document.getElementById('preview-content');
        const copyBtn = document.getElementById('copy-btn');
        const addCustomBtn = document.getElementById('add-custom-btn');
        const saveStatus = document.getElementById('save-status');
        const micBtn = document.getElementById('mic-btn');
        const templateBtn = document.getElementById('template-btn');
        const templateDropdown = document.getElementById('template-dropdown');

        const customModal = document.getElementById('custom-modal');
        const customLabelInput = document.getElementById('custom-label');
        const customTemplateInput = document.getElementById('custom-template');
        const saveCustomBtn = document.getElementById('save-custom-btn');
        const cancelCustomBtn = document.getElementById('cancel-custom-btn');

        let saveTimeout;
        let customButtons = [];
        let currentMarkdown = '';

        const templates = {
            readingMemo: `- **[èª­æ›¸ãƒ¡ãƒ¢]**
  - **æ›¸ç±å:** - **è‘—è€…:** - **ä¸€è¨€ã§è¨€ã†ã¨:** - **å­¦ã³ãƒ»æ°—ã¥ã:**
    - 
  - **å¼•ç”¨:**
    - "
      "`,
            meetingMinutes: `- **[è­°äº‹éŒ²]**
  - **ä¼šè­°å:** - **æ—¥æ™‚:** ${new Date().toLocaleString('ja-JP')}
  - **å‚åŠ è€…:** - **æ±ºå®šäº‹é …:**
    - 
  - **ToDo:**
    - [ ] `,
            ideaMemo: `- **[ã‚¢ã‚¤ãƒ‡ã‚¢]**
  - **èª²é¡Œ:** - **è§£æ±ºç­–:** - **æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—:** `
        };

        function getTodaysDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        function updatePreview() {
            const dateHeader = `## ${getTodaysDate()}\n\n`;
            const entries = entryInput.value;
            currentMarkdown = dateHeader + entries;

            const dirtyHtml = marked.parse(currentMarkdown);
            previewContent.innerHTML = DOMPurify.sanitize(dirtyHtml);
        }

        function saveToLocalStorage() {
            const content = {
                date: getTodaysDate(),
                text: entryInput.value
            };
            localStorage.setItem('dailyNoteContent', JSON.stringify(content));
            saveStatus.textContent = `ä¿å­˜æ¸ˆã¿: ${new Date().toLocaleTimeString()}`;
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => { saveStatus.textContent = ''; }, 2000);
        }

        function loadFromLocalStorage() {
            const savedContent = localStorage.getItem('dailyNoteContent');
            if (savedContent) {
                const content = JSON.parse(savedContent);
                if (content.date === getTodaysDate()) {
                    entryInput.value = content.text;
                } else {
                    entryInput.value = '';
                }
            }
            updatePreview();
        }

        function loadCustomButtons() {
            const savedButtons = localStorage.getItem('customDailyNoteButtons');
            if (savedButtons) {
                customButtons = JSON.parse(savedButtons);
                renderCustomButtons();
            }
        }

        function renderCustomButtons() {
            document.querySelectorAll('.custom-btn-item').forEach(btn => btn.remove());
            customButtons.forEach((button, index) => {
                const btnEl = document.createElement('button');
                btnEl.className = 'quick-add-btn custom-btn-item relative';
                btnEl.textContent = button.label;
                btnEl.dataset.template = button.template;

                const deleteBtn = document.createElement('span');
                deleteBtn.textContent = 'Ã—';
                deleteBtn.className = 'absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center opacity-50 hover:opacity-100';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`ã€Œ${button.label}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        customButtons.splice(index, 1);
                        localStorage.setItem('customDailyNoteButtons', JSON.stringify(customButtons));
                        renderCustomButtons();
                    }
                };
                btnEl.appendChild(deleteBtn);
                addCustomBtn.before(btnEl);
            });
            addQuickAddListeners();
        }

        function addQuickAddListeners() {
            document.querySelectorAll('.quick-add-btn').forEach(btn => {
                if (btn.id === 'add-custom-btn') return;
                btn.replaceWith(btn.cloneNode(true));
            });
            document.querySelectorAll('.quick-add-btn').forEach(btn => {
                if (btn.id === 'add-custom-btn') return;
                btn.addEventListener('click', () => {
                    const template = btn.dataset.template;
                    insertTemplate(template);
                });
            });
        }

        function insertTemplate(template) {
            const currentText = entryInput.value;
            const separator = currentText.length > 0 && !currentText.endsWith('\n\n') ? '\n\n' : '\n';
            const textToInsert = separator + template;
            const cursorPos = entryInput.selectionStart;

            entryInput.value = currentText.substring(0, cursorPos) + textToInsert + currentText.substring(cursorPos);

            const newCursorPos = cursorPos + textToInsert.length;
            entryInput.focus();
            entryInput.setSelectionRange(newCursorPos, newCursorPos);
            updatePreview();
            saveToLocalStorage();
        }

        entryInput.addEventListener('input', () => {
            updatePreview();
            saveToLocalStorage();
        });

        copyBtn.addEventListener('click', () => {
            const textArea = document.createElement("textarea");
            textArea.value = currentMarkdown;
            textArea.style.position = "absolute";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);

            copyBtn.textContent = 'Copied!';
            setTimeout(() => { copyBtn.textContent = 'ã‚³ãƒ”ãƒ¼'; }, 2000);
        });

        addCustomBtn.addEventListener('click', () => customModal.classList.remove('hidden'));
        cancelCustomBtn.addEventListener('click', () => customModal.classList.add('hidden'));
        saveCustomBtn.addEventListener('click', () => {
            const label = customLabelInput.value;
            const template = customTemplateInput.value;
            if (label && template) {
                customButtons.push({ label, template });
                localStorage.setItem('customDailyNoteButtons', JSON.stringify(customButtons));
                renderCustomButtons();
                customLabelInput.value = '';
                customTemplateInput.value = '';
                customModal.classList.add('hidden');
            } else {
                alert('ãƒ©ãƒ™ãƒ«ã¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        });

        // Template Dropdown
        templateBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            templateDropdown.classList.toggle('hidden');
        });
        document.addEventListener('click', () => templateDropdown.classList.add('hidden'));
        document.querySelectorAll('.template-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const templateId = e.target.dataset.templateId;
                if (templates[templateId]) {
                    insertTemplate(templates[templateId]);
                }
            });
        });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.interimResults = true;

            micBtn.addEventListener('click', () => {
                micBtn.classList.toggle('recording');
                if (micBtn.classList.contains('recording')) {
                    recognition.start();
                } else {
                    recognition.stop();
                }
            });

            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        transcript += event.results[i][0].transcript;
                    }
                }
                if (transcript) {
                    insertTemplate(transcript);
                }
            };

            recognition.onend = () => micBtn.classList.remove('recording');
        } else {
            micBtn.style.display = 'none';
        }

        entryInput.addEventListener('paste', async (e) => {
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const urlRegex = /https?:\/\/[^\s]+/g;
            const urls = pastedText.match(urlRegex);

            if (urls && urls.length > 0) {
                e.preventDefault();
                const url = urls[0];
                try {
                    const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                    if (response.ok) {
                        const html = await response.text();
                        const match = html.match(/<title>(.*?)<\/title>/);
                        const title = match ? match[1].trim() : 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜';
                        const markdownLink = `- **[ãƒªãƒ³ã‚¯]** [${title}](${url})`;
                        insertTemplate(markdownLink);
                    } else { throw new Error('Failed to fetch'); }
                } catch (error) {
                    console.error("Title fetch error:", error);
                    insertTemplate(`- **[ãƒªãƒ³ã‚¯]** [ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜](${url})`);
                }
            }
        });

        loadFromLocalStorage();
        loadCustomButtons();
        addQuickAddListeners();
    </script>
</body>

</html>